!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Instafeed=e()}(this,function(){"use strict";function t(t,e){if(!t)throw Error(e)}function e(e){t(!e||"object"==typeof e,"options must be an object, got "+e+" ("+typeof e+")");var o={accessToken:null,accessTokenTimeout:1e4,after:null,apiTimeout:1e4,apiLimit:null,before:null,debug:!1,error:null,filter:null,limit:null,mock:!1,render:null,sort:null,success:null,target:"instafeed",template:'<a href="{{link}}"><img title="{{caption}}" src="{{image}}" /></a>',templateBoundaries:["{{","}}"],transform:null};if(e)for(var n in o)void 0!==e[n]&&(o[n]=e[n]);t("string"==typeof o.target||"object"==typeof o.target,"target must be a string or DOM node, got "+o.target+" ("+typeof o.target+")"),t("string"==typeof o.accessToken||"function"==typeof o.accessToken,"accessToken must be a string or function, got "+o.accessToken+" ("+typeof o.accessToken+")"),t("number"==typeof o.accessTokenTimeout,"accessTokenTimeout must be a number, got "+o.accessTokenTimeout+" ("+typeof o.accessTokenTimeout+")"),t("number"==typeof o.apiTimeout,"apiTimeout must be a number, got "+o.apiTimeout+" ("+typeof o.apiTimeout+")"),t("boolean"==typeof o.debug,"debug must be true or false, got "+o.debug+" ("+typeof o.debug+")"),t("boolean"==typeof o.mock,"mock must be true or false, got "+o.mock+" ("+typeof o.mock+")"),t("object"==typeof o.templateBoundaries&&2===o.templateBoundaries.length&&"string"==typeof o.templateBoundaries[0]&&"string"==typeof o.templateBoundaries[1],"templateBoundaries must be an array of 2 strings, got "+o.templateBoundaries+" ("+typeof o.templateBoundaries+")"),t(!o.template||"string"==typeof o.template,"template must null or string, got "+o.template+" ("+typeof o.template+")"),t(!o.error||"function"==typeof o.error,"error must be null or function, got "+o.error+" ("+typeof o.error+")"),t(!o.before||"function"==typeof o.before,"before must be null or function, got "+o.before+" ("+typeof o.before+")"),t(!o.after||"function"==typeof o.after,"after must be null or function, got "+o.after+" ("+typeof o.after+")"),t(!o.success||"function"==typeof o.success,"success must be null or function, got "+o.success+" ("+typeof o.success+")"),t(!o.filter||"function"==typeof o.filter,"filter must be null or function, got "+o.filter+" ("+typeof o.filter+")"),t(!o.transform||"function"==typeof o.transform,"transform must be null or function, got "+o.transform+" ("+typeof o.transform+")"),t(!o.sort||"function"==typeof o.sort,"sort must be null or function, got "+o.sort+" ("+typeof o.sort+")"),t(!o.render||"function"==typeof o.render,"render must be null or function, got "+o.render+" ("+typeof o.render+")"),t(!o.limit||"number"==typeof o.limit,"limit must be null or number, got "+o.limit+" ("+typeof o.limit+")"),t(!o.apiLimit||"number"==typeof o.apiLimit,"apiLimit must null or number, got "+o.apiLimit+" ("+typeof o.apiLimit+")"),this._state={running:!1,node:null,token:null,paging:null,pool:[]},this._options=o}return e.prototype.run=function t(){var e=this;return(this._debug("run","options",this._options),this._debug("run","state",this._state),this._state.running)?(this._debug("run","already running, skipping"),!1):(this._start(),this._debug("run","getting dom node"),"string"==typeof this._options.target?this._state.node=document.getElementById(this._options.target):this._state.node=this._options.target,this._state.node)?(this._debug("run","got dom node",this._state.node),this._debug("run","getting access token"),this._getAccessToken(function t(o,n){if(o){e._debug("onTokenReceived","error",o),e._fail(Error("error getting access token: "+o.message));return}e._debug("onTokenReceived","got token",n),e._state.token=n,e._showNext(function t(o){if(o){e._debug("onNextShown","error",o),e._fail(o);return}e._finish()})}),!0):(this._fail(Error("no element found with ID "+this._options.target)),!1)},e.prototype.hasNext=function t(){var e=this._state.paging,o=this._state.pool;return this._debug("hasNext","paging",e),this._debug("hasNext","pool",o.length,o),o.length>0||e&&"string"==typeof e.next},e.prototype.next=function t(){var e=this;return e.hasNext()?e._state.running?(e._debug("next","already running, skipping"),!1):void(e._start(),e._showNext(function t(o){if(o){e._debug("onNextShown","error",o),e._fail(o);return}e._finish()})):(e._debug("next","hasNext is false, skipping"),!1)},e.prototype._showNext=function t(e){var o=this,n=null,s=null,i="number"==typeof this._options.limit;if(o._debug("showNext","pool",o._state.pool.length,o._state.pool),o._state.pool.length>0){if(s=i?o._state.pool.splice(0,o._options.limit):o._state.pool.splice(0),o._debug("showNext","items from pool",s.length,s),o._debug("showNext","updated pool",o._state.pool.length,o._state.pool),o._options.mock)o._debug("showNext","mock enabled, skipping render");else try{o._renderData(s)}catch(r){e(r);return}e(null)}else o._state.paging&&"string"==typeof o._state.paging.next?n=o._state.paging.next:(n="https://graph.instagram.com/me/media?fields=caption,id,media_type,media_url,permalink,thumbnail_url,timestamp,username&access_token="+o._state.token,o._options.apiLimit||"number"!=typeof o._options.limit?"number"==typeof o._options.apiLimit&&(o._debug("showNext","apiLimit set, overriding limit",o._options.apiLimit,o._options.limit),n=n+"&limit="+o._options.apiLimit):(o._debug("showNext","no apiLimit set, falling back to limit",o._options.apiLimit,o._options.limit),n=n+"&limit="+o._options.limit)),o._debug("showNext","making request",n),o._makeApiRequest(n,function t(n,s){var i=null;if(n){o._debug("onResponseReceived","error",n),e(Error("api request error: "+n.message));return}o._debug("onResponseReceived","data",s),o._success(s),o._debug("onResponseReceived","setting paging",s.paging),o._state.paging=s.paging;try{if(i=o._processData(s),o._debug("onResponseReceived","processed data",i),i.unused&&i.unused.length>0){o._debug("onResponseReceived","saving unused to pool",i.unused.length,i.unused);for(var r=0;r<i.unused.length;r++)o._state.pool.push(i.unused[r])}}catch(a){e(a);return}if(o._options.mock)o._debug("onResponseReceived","mock enabled, skipping append");else try{o._renderData(i.items)}catch(u){e(u);return}e(null)})},e.prototype._processData=function t(e){var o="function"==typeof this._options.transform,n="function"==typeof this._options.filter,s="function"==typeof this._options.sort,i="number"==typeof this._options.limit,r=[],a=null,u=null,p=null,l=null,c=null;if(this._debug("processData","hasFilter",n,"hasTransform",o,"hasSort",s,"hasLimit",i),"object"!=typeof e||"object"!=typeof e.data||e.data.length<=0)return null;for(var f=0;f<e.data.length;f++){if(u=this._getItemData(e.data[f]),o)try{p=this._options.transform(u),this._debug("processData","transformed item",u,p)}catch(g){throw this._debug("processData","error calling transform",g),Error("error in transform: "+g.message)}else p=u;if(n){try{l=this._options.filter(p),this._debug("processData","filter item result",p,l)}catch(d){throw this._debug("processData","error calling filter",d),Error("error in filter: "+d.message)}l&&r.push(p)}else r.push(p)}if(s)try{r.sort(this._options.sort)}catch(m){throw this._debug("processData","error calling sort",m),Error("error in sort: "+m.message)}return i&&(a=r.length-this._options.limit,this._debug("processData","checking limit",r.length,this._options.limit,a),a>0&&(c=r.slice(r.length-a),this._debug("processData","unusedItems",c.length,c),r.splice(r.length-a,a))),{items:r,unused:c}},e.prototype._extractTags=function t(e){var o=/#([^\s]+)/gi,n=/[~`!@#$%^&*\(\)\-\+={}\[\]:;"'<>\?,\./|\\\s]+/i,s=[],i=null;if("string"==typeof e)for(;null!==(i=o.exec(e));)!1===n.test(i[1])&&s.push(i[1]);return s},e.prototype._getItemData=function t(e){var o=null,n=null;switch(e.media_type){case"IMAGE":o="image",n=e.media_url;break;case"VIDEO":o="video",n=e.thumbnail_url;break;case"CAROUSEL_ALBUM":o="album",n=e.media_url}return{caption:e.caption,tags:this._extractTags(e.caption),id:e.id,image:n,link:e.permalink,model:e,timestamp:e.timestamp,type:o,username:e.username}},e.prototype._renderData=function t(e){var o="string"==typeof this._options.template,n="function"==typeof this._options.render,s=null,i=null,r=null,a="";if(this._debug("renderData","hasTemplate",o,"hasRender",n),"object"==typeof e&&!(e.length<=0)){for(var u=0;u<e.length;u++){if(s=e[u],n)try{i=this._options.render(s,this._options),this._debug("renderData","custom render result",s,i)}catch(p){throw this._debug("renderData","error calling render",p),Error("error in render: "+p.message)}else o&&(i=this._basicRender(s));i?a+=i:this._debug("renderData","render item did not return any content",s)}for(this._debug("renderData","html content",a),(r=document.createElement("div")).innerHTML=a,this._debug("renderData","container",r,r.childNodes.length,r.childNodes);r.childNodes.length>0;)this._debug("renderData","appending child",r.childNodes[0]),this._state.node.appendChild(r.childNodes[0])}},e.prototype._basicRender=function t(e){for(var o=RegExp(this._options.templateBoundaries[0]+"([\\s\\w.]+)"+this._options.templateBoundaries[1],"gm"),n=this._options.template,s=null,i="",r=null,a=0,u=null,p=null;null!==(s=o.exec(n));)u=s[1],i+=r=n.slice(a,s.index),(p=this._valueForKeyPath(u,e))&&(i+=p.toString()),a=o.lastIndex;return a<n.length&&(i+=r=n.slice(a,n.length)),i},e.prototype._valueForKeyPath=function t(e,o){for(var n=/([\w]+)/gm,s=null,i=null,r=o;null!==(s=n.exec(e));){if("object"!=typeof r)return null;r=r[i=s[1]]}return r},e.prototype._fail=function t(e){!this._runHook("error",e)&&console&&"function"==typeof console.error&&console.error(e),this._state.running=!1},e.prototype._start=function t(){this._state.running=!0,this._runHook("before")},e.prototype._finish=function t(){this._runHook("after"),this._state.running=!1},e.prototype._success=function t(e){this._runHook("success",e),this._state.running=!1},e.prototype._makeApiRequest=function t(e,o){var n=!1,s=this,i=null,r=function t(e,s){n||(n=!0,o(e,s))};(i=new XMLHttpRequest).ontimeout=function t(){r(Error("api request timed out"))},i.onerror=function t(){r(Error("api connection error"))},i.onload=function t(e){var o=i.getResponseHeader("Content-Type"),n=null;if(s._debug("apiRequestOnLoad","loaded",e),s._debug("apiRequestOnLoad","response status",i.status),s._debug("apiRequestOnLoad","response content type",o),o.indexOf("application/json")>=0)try{n=JSON.parse(i.responseText)}catch(a){s._debug("apiRequestOnLoad","json parsing error",a,i.responseText),r(Error("error parsing response json"));return}if(200!==i.status){n&&n.error?r(Error(n.error.code+" "+n.error.message)):r(Error("status code "+i.status));return}r(null,n)},i.open("GET",e,!0),i.timeout=this._options.apiTimeout,i.send()},e.prototype._getAccessToken=function t(e){var o=!1,n=this,s=null,i=function t(n,i){o||(o=!0,clearTimeout(s),e(n,i))};if("function"==typeof this._options.accessToken){this._debug("getAccessToken","calling accessToken as function"),s=setTimeout(function t(){n._debug("getAccessToken","timeout check",o),i(Error("accessToken timed out"),null)},this._options.accessTokenTimeout);try{this._options.accessToken(function t(e,s){n._debug("getAccessToken","received accessToken callback",o,e,s),i(e,s)})}catch(r){this._debug("getAccessToken","error invoking the accessToken as function",r),i(r,null)}}else this._debug("getAccessToken","treating accessToken as static",typeof this._options.accessToken),i(null,this._options.accessToken)},e.prototype._debug=function t(){var e=null;this._options.debug&&console&&"function"==typeof console.log&&(e=[].slice.call(arguments),e[0]="[Instafeed] ["+e[0]+"]",console.log.apply(null,e))},e.prototype._runHook=function t(e,o){var n=!1;if("function"==typeof this._options[e])try{this._options[e](o),n=!0}catch(s){this._debug("runHook","error calling hook",e,s)}return n},e});